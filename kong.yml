_format_version: "3.0"
_transform: true

vaults:
  - name: env
    prefix: my-env-vault
    config:
      prefix: "SECURE_"

services:
  # ======================
  # user-serv
  # ======================
  - name: user-serv
    url: http://user-serv.zeabur.internal:8080
    routes:
      # âœ… ç™»å…¥ï¼ˆå…¬é–‹ï¼‰
      - name: auth-google
        paths:
          - /v1/auth/google
        strip_path: false
        protocols: [http, https]

      # âœ… å…¬é–‹ï¼š/v1/users/:id
      - name: v1-public-users
        paths:
          - /v1/users
        strip_path: false
        protocols: [http, https]

      # âœ… å…¬é–‹ï¼š/v1/drivers/user/:user_id
      - name: v1-public-driver-by-user
        paths:
          - /v1/drivers/user
        strip_path: false
        protocols: [http, https]

      # ğŸ”’ å…¶é¤˜ /v1ï¼ˆéœ€è¦ JWTï¼‰
      - name: v1-protected
        paths:
          - /v1
        strip_path: false
        protocols: [http, https]

  # ======================
  # post-serv
  # ======================
  - name: post-serv
    url: http://post-serv.zeabur.internal:8080
    routes:
      # âœ… å…¬é–‹ï¼š/api/posts/all
      - name: api-posts-public
        paths:
          - /api/posts/all
        strip_path: false
        protocols: [http, https]

      - name: api-posts-search
        paths:
          - /api/posts/search
        strip_path: false
        protocols: [http, https]

      # ğŸ”’ å…¶é¤˜ /apiï¼ˆéœ€è¦ JWTï¼‰
      - name: api-protected
        paths:
          - /api
        strip_path: false
        protocols: [http, https]

  # ======================
  # admin-serv
  # ======================
  - name: admin-serv
    url: http://admin-serv.zeabur.internal:8080
    routes:
      - name: admin-protected
        paths:
          - /admin
        strip_path: false
        protocols: [http, https]

# ======================
# JWT
# ======================
consumers:
  - username: user-serv

jwt_secrets:
  - consumer: user-serv
    key: ntouber-user-serv
    secret: "f96dc63c15c49f1a181ba0d0df75d215381f0c5b12d27487402d66153405da33215da02619237d78f38f9e8bf863a98e"
    algorithm: HS256

plugins:
  # ğŸ”’ user-serv /v1
  - name: jwt
    route: v1-protected
    config:
      claims_to_verify: [exp]
      key_claim_name: kid
      run_on_preflight: false
      header_names:
        - Authorization

  # ğŸ”’ post-serv /api
  - name: jwt
    route: api-protected
    config:
      claims_to_verify: [exp]
      key_claim_name: kid
      run_on_preflight: false
      header_names:
        - Authorization

  # ğŸ”’ admin
  - name: jwt
    route: admin-protected
    config:
      claims_to_verify: [exp]
      key_claim_name: kid
      run_on_preflight: false
      header_names:
        - Authorization

  # ======================
  # CORS
  # ======================
  - name: cors
    config:
      origins:
        - https://ntouber.zeabur.app
        - http://localhost:8080
        - http://localhost:5173
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      headers:
        - Authorization
        - Content-Type
      exposed_headers:
        - Authorization
      credentials: false
      max_age: 3600
