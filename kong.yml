_format_version: "3.0"
_transform: true

vaults:
  - name: env
    prefix: my-env-vault
    config:
      prefix: ""

services:
  - name: user-serv
    url: http://user-serv.zeabur.internal:8080
    routes:
      # ✅ 登入：不需要 JWT
      - name: auth-google
        paths:
          - /v1/auth/google
        strip_path: false
        protocols: [http, https]

      # ✅ 其餘 /v1：需要 JWT（如果你希望 /v1 也保護）
      - name: v1-protected
        paths:
          - /v1
        strip_path: false
        protocols: [http, https]

  - name: post-serv
    url: http://post-serv.zeabur.internal:8080
    routes:
      - name: api-protected
        paths:
          - /api
        strip_path: false
        protocols: [http, https]

  - name: admin-serv
    url: http://admin-serv.zeabur.internal:8080
    routes:
      - name: admin-protected
        paths:
          - /admin
        strip_path: false
        protocols: [http, https]

# 讓 Kong 知道用哪個 secret 驗你簽出來的 JWT
consumers:
  - username: user-serv

jwt_secrets:
  - consumer: user-serv
    key: ntouber-user-serv
    secret: "{vault://my-env-vault/JWT_SECRET}"
    algorithm: HS256

plugins:
  - name: jwt
    route: v1-protected
    config:
      claims_to_verify: [exp]
      key_claim_name: kid
      run_on_preflight: false

  - name: jwt
    route: api-protected
    config:
      claims_to_verify: [exp]
      key_claim_name: kid
      run_on_preflight: false

  - name: jwt
    route: admin-protected
    config:
      claims_to_verify: [exp]
      key_claim_name: kid
      run_on_preflight: false

  - name: cors
    config:
      origins:
        - https://ntouber.zeabur.app
        - http://localhost:8080
        - http://localhost:5173
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      headers:
        - Authorization
        - Content-Type
      exposed_headers:
        - Authorization
      credentials: false
      max_age: 3600

