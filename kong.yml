_format_version: "3.0"
_transform: true

services:
  # ======================
  # user-serv
  # ======================
  - name: user-serv
    url: http://user-serv.zeabur.internal:8080
    routes:
      - name: auth-google
        paths: ["/v1/auth/google"]
        strip_path: false
        protocols: [http, https]

      - name: v1-public-users
        paths: ["/v1/users"]
        strip_path: false
        protocols: [http, https]

      - name: v1-public-driver-by-user
        paths: ["/v1/drivers/user"]
        strip_path: false
        protocols: [http, https]

      - name: v1-protected
        paths: ["/v1"]
        strip_path: false
        protocols: [http, https]

  # ======================
  # post-serv
  # ======================
  - name: post-serv
    url: http://post-serv.zeabur.internal:8080
    routes:
      - name: api-posts-public
        paths: ["/api/posts/all"]
        strip_path: false
        protocols: [http, https]

      - name: api-posts-search
        paths: ["/api/posts/search"]
        strip_path: false
        protocols: [http, https]

      - name: api-protected
        paths: ["/api"]
        strip_path: false
        protocols: [http, https]

  # ======================
  # admin-serv
  # ======================
  - name: admin-serv
    url: http://admin-serv.zeabur.internal:8080
    routes:
      - name: admin-protected
        paths: ["/admin"]
        strip_path: false
        protocols: [http, https]

# ======================
# Consumers / JWT
# ======================
consumers:
  - username: ntouber-user

jwt_secrets:
  - consumer: ntouber-user
    key: ntouber-user-serv
    secret: "REPLACE_WITH_YOUR_SECRET"
    algorithm: HS256

# ======================
# Plugins
# ======================
plugins:
  # ---------- JWT ----------
  - name: jwt
    route: v1-protected
    config:
      claims_to_verify: [exp]
      key_claim_name: iss
      run_on_preflight: false

  - name: jwt
    route: api-protected
    config:
      claims_to_verify: [exp]
      key_claim_name: iss
      run_on_preflight: false

  - name: jwt
    route: admin-protected
    config:
      claims_to_verify: [exp]
      key_claim_name: iss
      run_on_preflight: false

  # ---------- Rate Limiting ----------
  # ğŸ”“ å…¬é–‹ APIï¼ˆæœªç™»å…¥ / IPï¼‰
  - name: rate-limiting
    route: api-posts-public
    config:
      minute: 60
      hour: 1000
      limit_by: ip
      policy: local
      fault_tolerant: true

  - name: rate-limiting
    route: api-posts-search
    config:
      minute: 60
      hour: 1000
      limit_by: ip
      policy: local
      fault_tolerant: true

  # ğŸ”’ å·²ç™»å…¥ä½¿ç”¨è€…ï¼ˆJWT / Consumerï¼‰
  - name: rate-limiting
    route: v1-protected
    config:
      minute: 300
      hour: 5000
      limit_by: consumer
      policy: local
      fault_tolerant: true

  - name: rate-limiting
    route: api-protected
    config:
      minute: 300
      hour: 5000
      limit_by: consumer
      policy: local
      fault_tolerant: true

  # ğŸ” Adminï¼ˆæœ€åš´æ ¼ï¼‰
  - name: rate-limiting
    route: admin-protected
    config:
      minute: 30
      hour: 300
      limit_by: consumer
      policy: local
      fault_tolerant: true

  # ---------- CORS ----------
  - name: cors
    config:
      origins:
        - https://ntouber.zeabur.app
        - http://localhost:5173
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
        - PATCH
      headers:
        - Authorization
        - Content-Type
      exposed_headers:
        - Authorization
      credentials: false
      max_age: 3600
